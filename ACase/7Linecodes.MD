# 7Linecodes
## [现象：站点服务不可用的报警 七层SLB的CPU占用率达到了100%](https://github.com/r2010shadow/Cookbook/blob/master/ACase/7Linecodes.MD)

* 复盘
- - 晚上22:52
`收到服务不可用的报警`
`立马和相关技术人员拉了个紧急语音会议`
- - 晚上22:57
`运维发现承载全部在线业务的主机房七层SLB的CPU占用率达到了100%,无法处理用户请求，排除其他设施后，锁定故障为该层。`
`远程在家的程序员登上VPN却没法进入内网，只好又去call了一遍内网负责人，走了个绿色通道才全部上线（因为其中一个域名是由故障的SLB代理的）`
- - 晚上23:22
`运维先热重启了一遍SLB，未恢复；然后尝试拒绝用户流量冷重启SLB，CPU依然100%，还是未恢复。`
`运维发现多活机房SLB请求大量超时，但CPU未过载，正准备重启多活机房SLB时，内部群反应主站服务已恢复，视频播放、推荐、评论、动态等功能已基本正常。`
- - 晚上23:23 - 晚上23:53
`回滚了最近两周左右上线的Lua代码，都没把剩余的服务恢复。`
- - 凌晨12点
`bug仍为找出，另寻恢复方法`
- - 凌晨1点
`运维直接耗时一小时重建了一组全新的SLB集群。`
- - 凌晨1:50
`有人负责陆续将直播、电商、漫画、支付等核心业务流量切换到新集群，恢复全部服务。`
- - 凌晨4:00
`分析火焰图数据后，怀疑是该函数触发了jit编译器的某个bug，运行出错陷入死循环导致SLB CPU 100%。
于是就全局关闭了jit编译，暂时规避了风险。`
- - 后续
`线下环境复现了bug后，发现并不是jit编译器的问题，而是服务的某种特殊发布模式会出现容器实例权重为0的情况，而这个0是个字符串形式。`
``

* 分析bug
`字符串“0”在动态语言Lua中的算术操作中，被转成了数字，走到了不该走的分支，造成了死循环`

* 流量变化
`点不开就开始疯狂刷新，CDN流量回源重试 + 用户重试，直接让B站流量突增4倍以上，连接数突增100倍到千万级别，多活SLB就给整过载了。`

* 起源
```
local _gcd
_gcd = function (a,b)
    if b == 0 then
        return a
    end
    
    return _gcd (b, a % b)
end
```

* Lua具有这么几个特点
```
    这是一种动态类型语言，常用习惯里变量不需要定义类型，直接给变量赋值就行。
    Lua在对一个数字字符串进行算术操作时，会尝试将这个数字字符串转成一个数字。
    在Lua语言中，数学运算n%0的结果是nan(Not A Number)。
```


[7行代码崩溃3小时，竟因“一个诡计多端的0”](https://www.qbitai.com/2022/07/36300.html)



